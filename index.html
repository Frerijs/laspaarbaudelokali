<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8" />
  <title>LAS un CSV salīdzināšana (plas.io variants)</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    #results table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
    }
    #results th, #results td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>LAS un CSV salīdzināšana (EPSG:3059, ar plas.io)</h1>

  <p>1) Ielādējiet LAS failu (EPSG:3059)</p>
  <input type="file" id="lasFile" accept=".las,.laz" />

  <p>2) Ielādējiet CSV failu (kolonnas x,y,z vai X,Y,Z, EPSG:3059)</p>
  <input type="file" id="csvFile" accept=".csv,text/csv" />

  <br><br>
  <button id="processBtn">Sākt apstrādi</button>
  
  <div id="results"></div>

  <!-- Papa Parse bibliotēka CSV parsēšanai -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- plas.io dist (pašreizējā versija cdn.unpkg.com) -->
  <!-- Ja šeit redzat kļūdu 404, tad skatiet plas.io repozitoriju un meklējiet citu publisku CDN, vai ielādējiet lokāli. -->
  <script src="https://unpkg.com/plasio@latest/dist/plasio.js"></script>

  <script>
    const lasInput = document.getElementById('lasFile');
    const csvInput = document.getElementById('csvFile');
    const processBtn = document.getElementById('processBtn');
    const resultsDiv = document.getElementById('results');

    let lasPoints = [];  // šeit glabāsim {x, y, z} no LAS
    let csvPoints = [];  // šeit glabāsim {x, y, z} no CSV

    // 1) Funkcija, lai nolasītu LAS/LAZ failu ar plas.io
    function parseLASwithPlasio(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const buffer = event.target.result;

          // Izveidojam plas.io LAS ielādētāju
          // skip:1 (nelēc pāri punktiem); xyz:true (lai atgriež x,y,z)
          // Papildu parametri: https://github.com/verma/plasio#filelasloader
          let lasLoader = new plasio.FileLASLoader(buffer, {
            skip: 1
          });

          lasLoader.open()
            .then(() => {
              // Pavisam punkti
              const totalPoints = lasLoader.header.pointsCount;
              // Koordinātu mērogi un nobīdes
              const scale = [
                lasLoader.header.scaleX || 1,
                lasLoader.header.scaleY || 1,
                lasLoader.header.scaleZ || 1,
              ];
              const offset = [
                lasLoader.header.offsetX || 0,
                lasLoader.header.offsetY || 0,
                lasLoader.header.offsetZ || 0,
              ];

              let pointsArray = [];
              let chunkSize = 65536; // lasīsim chunkos pa 65k
              let readCount = 0;

              const readChunk = () => {
                // Ja esam izlasījuši visus punktus, beidzam
                if (readCount >= totalPoints) {
                  resolve(pointsArray);
                  return;
                }
                let toRead = Math.min(chunkSize, totalPoints - readCount);

                lasLoader.readData(toRead)
                  .then(chunk => {
                    // chunk.x, chunk.y, chunk.z ir TypedArrays
                    for (let i = 0; i < chunk.numPoints; i++) {
                      const X = (chunk.x[i]) * scale[0] + offset[0];
                      const Y = (chunk.y[i]) * scale[1] + offset[1];
                      const Z = (chunk.z[i]) * scale[2] + offset[2];

                      pointsArray.push({x: X, y: Y, z: Z});
                    }
                    readCount += chunk.numPoints;
                    readChunk(); // rekursīvi lasām nākamo chunk
                  })
                  .catch(err => reject(err));
              };
              readChunk();
            })
            .catch(err => reject(err));
        };
        reader.onerror = err => reject(err);
        reader.readAsArrayBuffer(file);
      });
    }

    // 2) CSV lasīšana ar Papa Parse
    function parseCSV(file) {
      return new Promise((resolve, reject) => {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            try {
              const data = results.data;
              let points = data.map(row => {
                const keys = {};
                // Pārveido kolonnas par mazajiem burtiem
                // lai varētu atrast x,y,z neatkarīgi no reģistra
                for (let k of Object.keys(row)) {
                  keys[k.toLowerCase()] = row[k];
                }
                const X = parseFloat(keys['x']);
                const Y = parseFloat(keys['y']);
                const Z = parseFloat(keys['z']);
                return {x: X, y: Y, z: Z};
              }).filter(pt => !isNaN(pt.x) && !isNaN(pt.y) && !isNaN(pt.z));
              resolve(points);
            } catch (err) {
              reject(err);
            }
          },
          error: (err) => reject(err)
        });
      });
    }

    // 3) Meklē tuvāko LAS punktu 20 cm rādiusā (naiva O(N) meklēšana)
    function findNearestLASPoint(csvPt, maxDistance=0.2) {
      let nearest = null;
      let minDist = Infinity;

      for (const lp of lasPoints) {
        const dx = lp.x - csvPt.x;
        const dy = lp.y - csvPt.y;
        const dist2D = Math.sqrt(dx*dx + dy*dy);
        if (dist2D <= maxDistance && dist2D < minDist) {
          minDist = dist2D;
          nearest = lp;
        }
      }
      return nearest;
    }

    // 4) Kad lietotājs spiež "Sākt apstrādi"
    processBtn.addEventListener('click', async () => {
      if (!lasInput.files.length || !csvInput.files.length) {
        alert("Lūdzu, atlasiet gan LAS, gan CSV failu!");
        return;
      }
      resultsDiv.innerHTML = "<p>Notiek lasīšana un aprēķins, uzgaidiet...</p>";

      try {
        // Ielasām LAS punktus
        lasPoints = await parseLASwithPlasio(lasInput.files[0]);
        
        // Ielasām CSV punktus
        csvPoints = await parseCSV(csvInput.files[0]);

        // Gatavojam HTML tabulu
        const rows = [];
        rows.push("<tr><th>CSV X</th><th>CSV Y</th><th>CSV Z</th><th>LAS Z</th><th>ΔZ</th><th>Attālums (2D)</th></tr>");

        for (const cpt of csvPoints) {
          const nearest = findNearestLASPoint(cpt, 0.2);  // 20cm
          if (nearest) {
            const dz = cpt.z - nearest.z;
            const dist2D = Math.sqrt((nearest.x - cpt.x)**2 + (nearest.y - cpt.y)**2);
            rows.push(
              `<tr>
                <td>${cpt.x.toFixed(3)}</td>
                <td>${cpt.y.toFixed(3)}</td>
                <td>${cpt.z.toFixed(3)}</td>
                <td>${nearest.z.toFixed(3)}</td>
                <td>${dz.toFixed(3)}</td>
                <td>${dist2D.toFixed(3)}</td>
              </tr>`
            );
          } else {
            // Ja nav tuvā punkta 20cm robežās
            rows.push(
              `<tr>
                <td>${cpt.x.toFixed(3)}</td>
                <td>${cpt.y.toFixed(3)}</td>
                <td>${cpt.z.toFixed(3)}</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
              </tr>`
            );
          }
        }

        resultsDiv.innerHTML = `
          <h3>Rezultāti</h3>
          <table>${rows.join("")}</table>
        `;

      } catch (err) {
        console.error(err);
        resultsDiv.innerHTML = `<p>Kļūda: ${err.message}</p>`;
      }
    });
  </script>
</body>
</html>
