<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8">
  <title>LAS & CSV Salīdzināšana</title>
  <!-- 1) Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <!-- 2) loaders.gl (core + las) -->
  <script src="https://cdn.jsdelivr.net/npm/@loaders.gl/core@3.3.2/dist/core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@loaders.gl/las@3.3.2/dist/las.min.js"></script>
</head>
<body>
  <h2>LAS & CSV Salīdzināšana</h2>
  <label for="lasFile">Augšupielādēt LAS:</label>
  <input type="file" id="lasFile" accept=".las"><br>
  <label for="csvFile">Augšupielādēt CSV:</label>
  <input type="file" id="csvFile" accept=".csv"><br><br>

  <label for="distance">Maksimālais attālums (cm):</label>
  <input type="number" id="distance" value="10" min="1" step="1">
  <button onclick="updateDistance()">Atjaunināt attālumu</button>
  <p id="distanceDisplay">Izvēlētais attālums: 10 cm</p><br>
  
  <button onclick="processFiles()">Salīdzināt</button>
  <p id="output"></p>

  <script>
    // Iekšēji metri (10 cm = 0.1 m)
    let maxDistance = 0.1;
    let lasPoints = [];

    function updateDistance() {
      let distCm = parseFloat(document.getElementById("distance").value);
      if (distCm < 1) {
        alert("Attālumam jābūt vismaz 1 cm!");
        return;
      }
      maxDistance = distCm / 100;
      document.getElementById("distanceDisplay").innerText =
        "Izvēlētais attālums: " + distCm + " cm";
    }

    async function processFiles() {
      let csvFile = document.getElementById("csvFile").files[0];
      let lasFile = document.getElementById("lasFile").files[0];
      if (!csvFile || !lasFile) {
        document.getElementById("output").innerText =
          "Lūdzu, augšupielādējiet gan CSV, gan LAS failus!";
        return;
      }

      // Pārbaudām, vai loaders.gl ielādēts
      if (!window.loaders || !window.loadersLAS) {
        console.error("loaders.gl nav pareizi ielādēts!");
        document.getElementById("output").innerText =
          "Kļūda: loaders.gl nav ielādēts!";
        return;
      }

      // 1) Ielasām LAS
      let lasReader = new FileReader();
      lasReader.onload = async (event) => {
        let lasBuffer = event.target.result;
        let lasData;
        try {
          lasData = await window.loaders.parse(
            lasBuffer,
            window.loadersLAS.LASLoader,
            {} // papildu opcijas
          );
        } catch (e) {
          console.error("Kļūda parsējot LAS:", e);
          document.getElementById("output").innerText =
            "Kļūda: Nevar nolasīt LAS failu!";
          return;
        }

        if (!lasData?.attributes?.POSITION?.value) {
          console.error("Kļūda: nav atrasti X,Y,Z dati LAS failā!");
          document.getElementById("output").innerText =
            "Kļūda: nav atrasti X,Y,Z dati LAS failā!";
          return;
        }

        // Float32Array [x1, y1, z1, x2, y2, z2,...]
        let positionsArray = lasData.attributes.POSITION.value;
        lasPoints = Array.from(positionsArray); // glabājam JS masīvā

        // 2) Ielasām CSV
        let csvReader = new FileReader();
        csvReader.onload = async (ev) => {
          let csvData = ev.target.result;

          // Pyodide + pakotnes
          let pyodide = await loadPyodide();
          await pyodide.loadPackage(["numpy", "pandas", "scipy"]);

          // Nododam lasPoints Python videi
          pyodide.globals.set("las_points", lasPoints);

          let pythonCode = `
import pandas as pd
import numpy as np
from scipy.spatial import cKDTree
from io import StringIO
from js import las_points

csv_df = pd.read_csv(StringIO("""${csvData}"""))
csv_df.columns = csv_df.columns.str.upper().str.strip()

required = {"X","Y","Z"}
if not required.issubset(csv_df.columns):
    raise ValueError(f"Trūkst kolonnas: {required - set(csv_df.columns)}")

csv_points = csv_df[['X','Y','Z']].to_numpy()

# Reshape Nx3
las_points = np.array(las_points, dtype=np.float64).reshape(-1, 3)

tree = cKDTree(las_points[:, :2])
distances, indices = tree.query(csv_points[:, :2], distance_upper_bound=${maxDistance})

valid_mask = (distances < ${maxDistance}) & (indices >= 0) & (indices < len(las_points))

z_diff = np.full(len(csv_points), np.nan)
z_diff[valid_mask] = csv_points[valid_mask,2] - las_points[indices[valid_mask],2]

csv_df["Z_Difference"] = z_diff

if np.all(np.isnan(csv_df["Z_Difference"])):
    result_csv = "Nav atrasti tuvākie LAS punkti noteiktajā attālumā."
else:
    result_csv = csv_df.to_csv(index=False)

result_csv
`;
          try {
            let result = await pyodide.runPythonAsync(pythonCode);
            if (result.includes("Nav atrasti tuvākie LAS")) {
              document.getElementById("output").innerText = result;
            } else {
              // Rezultāts ir CSV saturs
              document.getElementById("output").innerText =
                "Rezultāti sagatavoti. Lejupielādējiet CSV.";
              downloadCsv(result);
            }
          } catch (err) {
            console.error("Kļūda apstrādājot CSV+LAS:", err);
            document.getElementById("output").innerText =
              "Kļūda apstrādājot failus.";
          }
        };
        csvReader.readAsText(csvFile);
      };
      lasReader.readAsArrayBuffer(lasFile);
    }

    function downloadCsv(csvContent) {
      let blob = new Blob([csvContent], {type: "text/csv"});
      let link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "las_vs_csv_results.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
