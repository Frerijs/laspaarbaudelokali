<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8">
  <title>LAS un CSV salīdzināšana, izmantojot loaders.gl</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    #results table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
    }
    #results th, #results td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>LAS un CSV salīdzināšana (EPSG:3059) ar loaders.gl</h1>

  <p>1) Ielādējiet LAS/LAZ failu (EPSG:3059)</p>
  <input type="file" id="lasFile" accept=".las,.laz" />

  <p>2) Ielādējiet CSV failu (EPSG:3059, kolonnas x,y,z vai X,Y,Z)</p>
  <input type="file" id="csvFile" accept=".csv,text/csv" />

  <br><br>
  <button id="processBtn">Sākt apstrādi</button>
  
  <div id="results"></div>

  <!-- PapaParse CSV lasīšanai -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Izmanto ES moduļus -->
  <script type="module">
    import {load} from 'https://cdn.jsdelivr.net/npm/@loaders.gl/core@3.2.3/dist/esm/index.js';
    import {LASLoader} from 'https://cdn.jsdelivr.net/npm/@loaders.gl/las@3.2.3/dist/esm/index.js';

    const lasInput = document.getElementById('lasFile');
    const csvInput = document.getElementById('csvFile');
    const processBtn = document.getElementById('processBtn');
    const resultsDiv = document.getElementById('results');

    let lasPoints = [];
    let csvPoints = [];

    // ---------------------------------------------
    // 1) Nolasa .las / .laz failu ar loaders.gl
    // ---------------------------------------------
    async function parseLAS(file) {
      const arrayBuffer = await file.arrayBuffer();
      const data = await load(arrayBuffer, LASLoader);
      // data -> { loader, header, points, ... }
      
      // data.points ir objekts, kas satur "POSITION", "Intensity" u.c.
      // POSITION ir Float32Array: [x1, y1, z1, x2, y2, z2, ...]
      // Koordinātas jau mērogotas + offsetotas reālajās vienībās
      // (jaunākās loaders.gl versijās).
      // Pārbaudiet data.header.scale un data.header.offset, ja vajag manual korekciju.

      const {POSITION} = data.points;
      // POSITION.length = 3 * pointCount
      // tātad punkti:
      const pointCount = POSITION.length / 3;
      const pointsArray = [];
      for (let i = 0; i < pointCount; i++) {
        const x = POSITION[3*i + 0];
        const y = POSITION[3*i + 1];
        const z = POSITION[3*i + 2];
        pointsArray.push({x, y, z});
      }
      return pointsArray;
    }

    // ---------------------------------------------
    // 2) Nolasa CSV ar Papa Parse
    // ---------------------------------------------
    function parseCSV(file) {
      return new Promise((resolve, reject) => {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            try {
              const data = results.data;
              const points = data.map(row => {
                const keys = {};
                for (let k of Object.keys(row)) {
                  keys[k.toLowerCase()] = row[k];
                }
                const X = parseFloat(keys['x']);
                const Y = parseFloat(keys['y']);
                const Z = parseFloat(keys['z']);
                return {x: X, y: Y, z: Z};
              }).filter(pt => !isNaN(pt.x) && !isNaN(pt.y) && !isNaN(pt.z));
              resolve(points);
            } catch (err) {
              reject(err);
            }
          },
          error: (err) => {
            reject(err);
          }
        });
      });
    }

    // ---------------------------------------------
    // 3) Meklē tuvāko LAS punktu 20cm rādiusā
    // ---------------------------------------------
    function findNearestLASPoint(csvPt, maxDistance = 0.2) {
      let nearest = null;
      let minDist = Infinity;
      for (const lasPt of lasPoints) {
        const dx = lasPt.x - csvPt.x;
        const dy = lasPt.y - csvPt.y;
        const dist2D = Math.sqrt(dx*dx + dy*dy);
        if (dist2D <= maxDistance && dist2D < minDist) {
          minDist = dist2D;
          nearest = lasPt;
        }
      }
      return nearest;
    }

    // ---------------------------------------------
    // 4) Process (pogas klikšķis)
    // ---------------------------------------------
    processBtn.addEventListener('click', async () => {
      if (!lasInput.files.length || !csvInput.files.length) {
        alert("Lūdzu, atlasiet gan LAS/LAZ, gan CSV failu!");
        return;
      }
      resultsDiv.innerHTML = "Notiek datu ielāde, lūdzu uzgaidiet...";

      try {
        // Nolasām visus LAS punktus
        lasPoints = await parseLAS(lasInput.files[0]);
        // Nolasām CSV
        csvPoints = await parseCSV(csvInput.files[0]);

        // Apstrāde un rezultātu ģenerēšana
        const rows = [];
        rows.push("<tr><th>CSV X</th><th>CSV Y</th><th>CSV Z</th><th>LAS Z</th><th>ΔZ</th><th>Attālums 2D</th></tr>");

        for (const cpt of await csvPoints) {
          const nearest = findNearestLASPoint(cpt, 0.2);
          if (nearest) {
            const dz = cpt.z - nearest.z;
            const dist2D = Math.sqrt(Math.pow(nearest.x - cpt.x, 2) + Math.pow(nearest.y - cpt.y, 2));
            rows.push(`<tr>
              <td>${cpt.x.toFixed(3)}</td>
              <td>${cpt.y.toFixed(3)}</td>
              <td>${cpt.z.toFixed(3)}</td>
              <td>${nearest.z.toFixed(3)}</td>
              <td>${dz.toFixed(3)}</td>
              <td>${dist2D.toFixed(3)}</td>
            </tr>`);
          } else {
            // Ja nav atrasts tuvākais <=20cm
            rows.push(`<tr>
              <td>${cpt.x.toFixed(3)}</td>
              <td>${cpt.y.toFixed(3)}</td>
              <td>${cpt.z.toFixed(3)}</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
            </tr>`);
          }
        }

        const tableHtml = `<table>${rows.join('')}</table>`;
        resultsDiv.innerHTML = "<h3>Rezultāti</h3>" + tableHtml;
      } catch (err) {
        console.error(err);
        resultsDiv.innerHTML = `<p>Kļūda: ${err.message}</p>`;
      }
    });
  </script>
</body>
</html>
